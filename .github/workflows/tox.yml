---
name: Tox Workflow
'on':
  workflow_call:
jobs:
  tox:
      runs-on: ubuntu-20.04
      strategy:
        fail-fast: false
        matrix:
          python38:
            - ${{
                 (github.repository != 'stackhpc/kayobe') &&
                 ((github.base_ref == 'stackhpc/wallaby') ||
                 (github.ref == 'refs/heads/stackhpc/wallaby') ||
                 (github.base_ref == 'stackhpc/xena') ||
                 (github.ref == 'refs/heads/stackhpc/xena') ||
                 (github.base_ref == 'stackhpc/yoga') ||
                 (github.ref == 'refs/heads/stackhpc/yoga'))
               }}
          python310:
            - ${{
                 (github.base_ref == 'stackhpc/2023.1') ||
                 (github.ref == 'refs/heads/stackhpc/2023.1') ||
                 (github.base_ref == 'stackhpc/2024.1') ||
                 (github.ref == 'refs/heads/stackhpc/2024.1')
               }}
          python312:
            - ${{
                 (github.base_ref == 'stackhpc/2025.1') ||
                 (github.ref == 'refs/heads/stackhpc/2025.1') ||
                 (github.base_ref == 'stackhpc/master') ||
                 (github.ref == 'refs/heads/stackhpc/master')
               }}
          repository:
            - ${{ github.repository }}
          include:
            # Releases are tested with their main and previous Python versions
            # Linting is only done with the main Python version.

            # Python 3.8
            - python38: true
              environment: pep8
              python-minor-version: 8
            - python38: true
              environment: py3
              python-minor-version: 8
            - python38: true
              environment: py3
              python-minor-version: 6
            # Python 3.10
            - python310: true
              environment: pep8
              python-minor-version: 10
            - python310: true
              environment: py3
              python-minor-version: 10
            - python310: true
              environment: py3
              python-minor-version: 8
            # Python 3.12
            - python312: true
              environment: pep8
              python-minor-version: 12
            - python312: true
              environment: py3
              python-minor-version: 12
            - python312: true
              environment: py3
              python-minor-version: 10
          exclude:
            - python38: false
            - python310: false
            - python312: false
            - python38: true
              repository: stackhpc/kayobe

      name: Tox ${{ matrix.environment }} with Python 3.${{ matrix.python-minor-version }}
      steps:
        - name: Github Checkout üõé
          uses: actions/checkout@v4
        - name: Setup Python 3.${{ matrix.python-minor-version }} üêç
          uses: actions/setup-python@v5
          with:
            python-version: 3.${{ matrix.python-minor-version }}
        - name: Install bindep üì¶
          run: |
            if [[ -f bindep.txt ]]; then
                pip install bindep
            else
                echo "No bindep.txt"
            fi
        - name: Install missing packages üì¶
          run: |
            if [[ -f bindep.txt ]]; then
                sudo apt install $(bindep -b test)
            else
                echo "No bindep.txt"
            fi
        - name: Install Tox üì¶
          run: pip install tox
        - name: Run Tox pep8 üß™
          run: tox -e pep8
          if: ${{ matrix.environment == 'pep8' }}
        - name: Run Tox py3${{ matrix.python-minor-version }} üß™
          run: tox -e py3${{ matrix.python-minor-version }}
          if: ${{ matrix.environment == 'py3' }}
