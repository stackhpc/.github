---
name: Tox Workflow
'on':
  workflow_call:
jobs:
  tox:
      runs-on: ubuntu-latest
      strategy:
        fail-fast: false
        matrix:
          environment: [pep8,py3]
          python-minor-version: [8,10,12]
          is-not-python38:
            - ${{
                  ((github.repository == 'stackhpc/kayobe') &&
                  ((github.base_ref == 'stackhpc/2024.1') ||
                  (github.ref == 'refs/heads/stackhpc/2024.1'))) ||
                  (github.base_ref == 'stackhpc/2025.1') ||
                  (github.ref == 'refs/heads/stackhpc/2025.1') ||
                  (github.base_ref == 'stackhpc/master') ||
                  (github.ref == 'refs/heads/stackhpc/master')
                }}
          is-primarily-python312:
            - ${{
                  (github.base_ref == 'stackhpc/2025.1') ||
                  (github.ref == 'refs/heads/stackhpc/2025.1') ||
                  (github.base_ref == 'stackhpc/master') ||
                  (github.ref == 'refs/heads/stackhpc/master')
                }}
          exclude:
            - is-not-python38: true
              python-minor-version: 8
            - is-primarily-python312: true
              environment: pep8
              python-minor-version: 10
            - is-primarily-python312: false
              python-minor-version: 12

      name: Tox ${{ matrix.environment }} with Python 3.${{ matrix.python-minor-version }}
      steps:
        - name: Github Checkout 🛎
          uses: actions/checkout@v4
        - name: Setup Python 3.${{ matrix.python-minor-version }} 🐍
          uses: actions/setup-python@v5
          with:
            python-version: 3.${{ matrix.python-minor-version }}
        - name: Install bindep 📦
          run: |
            if [[ -f bindep.txt ]]; then
                pip install bindep
            else
                echo "No bindep.txt"
            fi
        - name: Install missing packages 📦
          run: |
            if [[ -f bindep.txt ]]; then
                sudo apt update && sudo apt install $(bindep -b test)
            else
                echo "No bindep.txt"
            fi
        - name: Install Tox 📦
          run: pip install tox
        - name: Run Tox pep8 🧪
          run: tox -e pep8
          if: ${{ matrix.environment == 'pep8' }}
        - name: Run Tox py3${{ matrix.python-minor-version }} 🧪
          run: tox -e py3${{ matrix.python-minor-version }}
          if: ${{ matrix.environment == 'py3' }}
